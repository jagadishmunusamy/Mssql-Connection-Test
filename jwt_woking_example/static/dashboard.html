<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <style>
    body { font-family: system-ui, Arial; margin: 2rem; }
    code { background:#f5f5f5; padding:.25rem .5rem; }
    button { padding:.5rem; margin-right:.5rem; }
    .log { white-space: pre-wrap; background:#fafafa; border:1px solid #eee; padding:.75rem; border-radius:6px; min-height:120px }
  </style>
</head>
<body>
  <h1>Dashboard (Protected)</h1>

  <p>Access token (session): <code id="tok">(none)</code></p>

  <p>
    <button id="btnPing">Call /api/hello</button>
    <button id="btnReports">Go to Reports</button>
    <button id="btnLogout">Logout</button>
  </p>

  <div class="log" id="log"></div>

  <script>
    // ====== token state ======
    let accessToken = sessionStorage.getItem("access_token") || null;

    // ====== tiny helpers ======
    const $ = (id) => document.getElementById(id);
    const log = (m) => $("log").textContent += m + "\n";
    const showTok = () => $("tok").textContent = accessToken ? (accessToken.slice(0, 24) + "…") : "(none)";

    // ====== fetch helper with silent refresh ======
    async function fetchWithRefresh(input, init = {}) {
      const headers = new Headers(init.headers || {});
      if (accessToken) headers.set("Authorization", `Bearer ${accessToken}`);

      let res = await fetch(input, { ...init, headers, credentials: "include" });
      if (res.status !== 401) return res;

      // Access expired → try refresh using HttpOnly cookie
      log("Access expired → refreshing…");
      const r = await fetch("/auth/refresh", { method: "POST", credentials: "include" });
      if (!r.ok) {
        log("Refresh failed → back to login");
        sessionStorage.removeItem("access_token");
        window.location.href = "/";
        return res;
      }

      const data = await r.json();
      if (!(data.ok && data.access_token)) {
        log("Invalid refresh → back to login");
        sessionStorage.removeItem("access_token");
        window.location.href = "/";
        return res;
      }

      accessToken = data.access_token;
      sessionStorage.setItem("access_token", accessToken);
      showTok();
      log("Got new access token → retrying request…");

      const retryHeaders = new Headers(init.headers || {});
      retryHeaders.set("Authorization", `Bearer ${accessToken}`);
      return fetch(input, { ...init, headers: retryHeaders, credentials: "include" });
    }

    // ====== bootstrap on load ======
    (async function bootstrap() {
      showTok();

      // If page loaded without an access token (new tab or reload), mint one via refresh cookie
      if (!accessToken) {
        const r = await fetch("/auth/refresh", { method: "POST", credentials: "include" });
        if (r.ok) {
          const data = await r.json();
          if (data.ok && data.access_token) {
            accessToken = data.access_token;
            sessionStorage.setItem("access_token", accessToken);
            showTok();
            log("Bootstrapped access token from refresh cookie.");
          }
        } else {
          log("No refresh cookie. Redirecting to login.");
          window.location.href = "/";
          return;
        }
      }

      // Demo polling: call API every 5s so you can watch auto-refresh after ~15s
      setInterval(async () => {
        const res = await fetchWithRefresh("/api/hello");
        if (res.ok) {
          const j = await res.json();
          log("API: " + j.message);
        }
      }, 5000);
    })();

    // ====== UI events ======
    $("btnPing").addEventListener("click", async () => {
      const res = await fetchWithRefresh("/api/hello");
      const text = await res.text();
      try { log("Manual call: " + JSON.stringify(JSON.parse(text))); }
      catch { log("Manual call (raw): " + text); }
    });

    // NEW: navigate to Reports page (protected page with same refresh behavior)
    $("btnReports").addEventListener("click", () => {
      window.location.href = "/reports";
    });

    $("btnLogout").addEventListener("click", async () => {
      await fetch("/auth/logout", { method: "POST", credentials: "include" });
      sessionStorage.removeItem("access_token");
      window.location.href = "/";
    });
  </script>
</body>
</html>
